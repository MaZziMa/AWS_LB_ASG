version: "3.9"

services:
  dynamodb:
    image: amazon/dynamodb-local:latest
    container_name: course-reg-dynamodb
    command: -jar DynamoDBLocal.jar -sharedDb
    ports:
      - "8001:8000"

  redis:
    image: redis:7
    container_name: course-reg-redis
    ports:
      - "6379:6379"

  # One-off init to create DynamoDB tables on local
  dynamodb-init:
    image: python:3.11-slim
    container_name: course-reg-dynamodb-init
    depends_on:
      - dynamodb
    working_dir: /app
    environment:
      DYNAMODB_REGION: us-east-1
      DYNAMODB_ENDPOINT_URL: http://dynamodb:8000
      DYNAMODB_TABLE_PREFIX: CourseReg
      AWS_REGION: us-east-1
   
    volumes:
      - ./backend:/app:ro
    command: >
      bash -c "pip install -q -r requirements.txt && 
      python -c 'from app.config import settings; from app.dynamodb import db, init_tables; db.connect(); print(\"Creating tables...\"); init_tables(); print(\"Done\")'"
    restart: "no"

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: course-reg-backend
    depends_on:
      - dynamodb
      - redis
      - dynamodb-init
    environment:
      APP_NAME: Course Registration System
      APP_VERSION: "1.0.0"
      DEBUG: "true"
      ENVIRONMENT: development
      HOST: 0.0.0.0
      PORT: "8000"
      WORKERS: "1"
      DYNAMODB_REGION: us-east-1
      DYNAMODB_ENDPOINT_URL: http://dynamodb:8000
      DYNAMODB_TABLE_PREFIX: CourseReg
      REDIS_URL: redis://redis:6379/0
      CORS_ORIGINS: '["http://localhost:3000"]'
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: dummy
      AWS_SECRET_ACCESS_KEY: dummy
    ports:
      - "8000:8000"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: course-reg-frontend
    depends_on:
      - backend
    environment:
      # Vite dev server runs on 0.0.0.0; frontend calls backend via localhost:8000 from browser
      NODE_ENV: development
    ports:
      - "3000:3000"

networks:
  default:
    name: course-reg-net
