# Environment Variables Management Guide

## üîê Security Best Practices

### ‚ùå NEVER DO THIS (in .env file):
```env
AWS_ACCESS_KEY_ID=AKIAXXXXXXXXXXX
AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxx
```

### ‚úÖ DO THIS INSTEAD:
```env
AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
```
**Why?** EC2 instances use **IAM Role** (`MyEC2Profile`) to automatically get credentials. No hardcoded secrets needed!

---

## üìã How Environment Variables Work

### On Local Development:
1. Edit `backend/.env` file
2. Run `cd backend && python main.py`
3. Application reads from `.env` using `pydantic-settings`

### On EC2 (Production):
1. **File `.env` is auto-generated** during deployment by `user-data.sh`
2. **AWS credentials come from IAM Role** (not from file)
3. **Application reads same way** - transparent!

---

## üöÄ Deployment Options

### Option 1: Full Deploy (Recommended)
Deploys entire project with latest code and fresh `.env`:

```powershell
cd infrastructure
.\init-database.ps1        # Creates DynamoDB tables with sample data
.\deploy-project.ps1       # Builds, packages, uploads, and deploys
```

**What it does:**
- Builds frontend (React ‚Üí static files)
- Packages backend + frontend ‚Üí ZIP
- Uploads to S3 bucket
- Creates `.env` with all variables on EC2
- Installs dependencies and starts service

### Option 2: Update Existing Instance
Update environment variables on running instance without redeploying:

```powershell
# View current configuration
.\view-env.ps1 -InstanceIp 34.207.173.116

# Update specific variables
.\update-env.ps1 -InstanceIp 34.207.173.116 -EnvVars @{
    DEBUG = "True"
    SQS_QUEUE_URL = "https://sqs.us-east-1.amazonaws.com/171308902397/Course_project.fifo"
    RATE_LIMIT_PER_MINUTE = "200"
}
```

**What it does:**
- SSHs into instance
- Updates specified variables in `.env`
- Restarts application service
- Verifies service is running

---

## üìù Environment Variables Reference

### Application Settings
```env
APP_NAME=Course Registration System
APP_VERSION=1.0.0
DEBUG=False                          # Set True for detailed logs
ENVIRONMENT=production               # development | staging | production
```

### Server Configuration
```env
HOST=0.0.0.0                        # Listen on all interfaces
PORT=8000                           # Application port
WORKERS=4                           # Uvicorn workers (2-4 for t3.micro)
```

### Database (DynamoDB)
```env
DYNAMODB_REGION=us-east-1
DYNAMODB_ENDPOINT_URL=              # Empty for AWS, or http://localhost:8000 for local
DYNAMODB_TABLE_PREFIX=CourseReg     # All tables: CourseReg_Users, CourseReg_Courses, etc.
```

### Cache (Redis)
```env
REDIS_URL=redis://localhost:6379/0  # Local Redis or ElastiCache endpoint
REDIS_PASSWORD=                      # Password if required
REDIS_MAX_CONNECTIONS=50
```

### Authentication
```env
SECRET_KEY=<auto-generated-32-bytes> # Generated by: openssl rand -hex 32
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

### AWS Services
```env
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=                   # Empty - uses IAM role
AWS_SECRET_ACCESS_KEY=               # Empty - uses IAM role
```

### AWS SQS (Optional)
```env
SQS_QUEUE_URL=                       # Your SQS queue URL
SQS_EMAIL_QUEUE_URL=                 # Email notification queue
```

### AWS S3
```env
S3_BUCKET_NAME=course-reg-deployment-xxxxx  # Auto-created by deploy script
```

### CloudWatch Monitoring
```env
CLOUDWATCH_NAMESPACE=CourseRegistration
CLOUDWATCH_LOG_GROUP=/aws/course-registration
```

### Rate Limiting
```env
RATE_LIMIT_PER_MINUTE=100           # API calls per minute per IP
MAX_ENROLLMENT_PER_REQUEST=5        # Max courses per enrollment request
```

### CORS (Cross-Origin)
```env
CORS_ORIGINS=["*"]                   # Allow all origins (restrict for production)
# Or specific origins:
# CORS_ORIGINS=["https://yourdomain.com","https://app.yourdomain.com"]
```

### Email (SES - Optional)
```env
SES_SENDER_EMAIL=noreply@example.com
SES_REGION=us-east-1
```

### Background Tasks (Celery - Optional)
```env
CELERY_BROKER_URL=redis://localhost:6379/1
CELERY_RESULT_BACKEND=redis://localhost:6379/2
```

### Monitoring
```env
PROMETHEUS_PORT=9090
```

---

## üîß Common Tasks

### View Current Configuration
```powershell
# Automatic (finds instance from ASG)
.\view-env.ps1

# Manual (specify IP)
.\view-env.ps1 -InstanceIp 34.207.173.116
```

### Update Single Variable
```powershell
.\update-env.ps1 -InstanceIp 34.207.173.116 -EnvVars @{
    DEBUG = "True"
}
```

### Update Multiple Variables
```powershell
.\update-env.ps1 -InstanceIp 34.207.173.116 -EnvVars @{
    DEBUG = "False"
    RATE_LIMIT_PER_MINUTE = "200"
    SQS_QUEUE_URL = "https://sqs.us-east-1.amazonaws.com/171308902397/your-queue.fifo"
    CORS_ORIGINS = '["https://yourdomain.com"]'
}
```

### Enable Debug Mode
```powershell
.\update-env.ps1 -InstanceIp 34.207.173.116 -EnvVars @{
    DEBUG = "True"
    ENVIRONMENT = "development"
}
```

### SSH and Manually Edit
```powershell
ssh -i ..\course-reg-key.pem ec2-user@34.207.173.116

# On instance:
sudo nano /opt/course-registration/backend/.env
sudo systemctl restart course-registration
sudo journalctl -u course-registration -f
```

---

## üß™ Testing Configuration

### Test DynamoDB Connection
```bash
ssh -i course-reg-key.pem ec2-user@<instance-ip>
cd /opt/course-registration/backend

python3.11 << 'EOF'
from app.dynamodb import db
db.connect()
print("‚úì DynamoDB connected")
tables = db.client.list_tables()
print(f"Tables: {tables['TableNames']}")
EOF
```

### Test Redis Connection
```bash
python3.11 << 'EOF'
import redis
r = redis.from_url('redis://localhost:6379/0')
r.ping()
print("‚úì Redis connected")
EOF
```

### Test Health Endpoint
```bash
curl http://localhost:8000/health
```

---

## üîç Troubleshooting

### Service Not Starting
```bash
# View logs
sudo journalctl -u course-registration -n 50

# Check configuration syntax
cd /opt/course-registration/backend
python3.11 -c "from app.config import settings; print(settings.APP_NAME)"
```

### DynamoDB Access Denied
**Problem:** IAM role missing permissions

**Solution:**
```powershell
# Re-run deploy script (it updates IAM automatically)
.\deploy-project.ps1
```

### Variables Not Updating
**Problem:** Service not restarted after .env change

**Solution:**
```bash
sudo systemctl restart course-registration
```

---

## üìö Additional Resources

- **Backend Config:** `backend/app/config.py`
- **Deploy Script:** `infrastructure/deploy-project.ps1`
- **IAM Policy:** Check `MyEC2Profile` role in AWS Console
- **DynamoDB Tables:** `aws dynamodb list-tables --region us-east-1`
